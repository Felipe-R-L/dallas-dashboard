<div class="mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
  @if (datasets$ | async; as datasets) {
    <app-dashboard-filter
      [datasets]="datasets | datasetsToOptions"
      (filterChange)="onDateRangeChange($event)"
      (newCompany)="openCreateDatasetModal()"
      (importFile)="openUploadModal()"
    ></app-dashboard-filter>

    @if (hasDatasets) {
      <section class="mt-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-5">
        <div
          class="rounded-xl border border-border-glass bg-surface-glass p-5 shadow-lg backdrop-blur-md"
        >
          <h3 class="truncate text-sm font-medium text-text-muted">Faturamento Bruto</h3>
          <p class="mt-2 whitespace-nowrap text-2xl font-semibold text-text-base md:text-3xl">
            {{ grossRevenue | currency: 'BRL' }}
          </p>
        </div>
        <div
          class="rounded-xl border border-border-glass bg-surface-glass p-5 shadow-lg backdrop-blur-md"
        >
          <h3 class="truncate text-sm font-medium text-text-muted">Despesa Total</h3>
          <p class="mt-2 whitespace-nowrap text-2xl font-semibold text-text-base md:text-3xl">
            {{ totalExpenses | currency: 'BRL' }}
          </p>
        </div>
        <div
          class="rounded-xl border border-border-glass bg-surface-glass p-5 shadow-lg backdrop-blur-md"
        >
          <h3 class="truncate text-sm font-medium text-text-muted">Lucro Líquido</h3>
          <p
            class="mt-2 whitespace-nowrap text-2xl font-semibold md:text-3xl"
            [ngClass]="netProfit > 0 ? 'text-green-400' : 'text-red-500'"
          >
            {{ netProfit | currency: 'BRL' }}
          </p>
        </div>
        <div
          class="rounded-xl border border-border-glass bg-surface-glass p-5 shadow-lg backdrop-blur-md"
        >
          <h3 class="truncate text-sm font-medium text-text-muted">Margem de Lucro</h3>
          <p class="mt-2 whitespace-nowrap text-2xl font-semibold text-text-base md:text-3xl">
            {{ profitMargin | percent: '1.2-2' }}
          </p>
        </div>
        <div
          class="rounded-xl border border-border-glass bg-surface-glass p-5 shadow-lg backdrop-blur-md"
        >
          <h3 class="truncate text-sm font-medium text-text-muted">Ticket Médio</h3>
          <p class="mt-2 whitespace-nowrap text-2xl font-semibold text-text-base md:text-3xl">
            {{ averageTicket | currency: 'BRL' }}
          </p>
        </div>
      </section>

      <main class="mt-8">
        <div class="border-b border-border-glass">
          <nav class="-mb-px flex space-x-6">
            <button
              (click)="selectTab('revenue')"
              [ngClass]="{
                'border-accent-start text-accent-start': activeTab === 'revenue',
                'border-transparent text-text-muted hover:border-border-glow hover:text-text-base':
                  activeTab !== 'revenue',
              }"
              class="whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium transition-colors"
            >
              Faturamento
            </button>
            <button
              (click)="selectTab('expenses')"
              [ngClass]="{
                'border-accent-start text-accent-start': activeTab === 'expenses',
                'border-transparent text-text-muted hover:border-border-glow hover:text-text-base':
                  activeTab !== 'expenses',
              }"
              class="whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium transition-colors"
            >
              Despesas
            </button>
            <button
              (click)="selectTab('files')"
              [ngClass]="{
                'border-accent-start text-accent-start': activeTab === 'files',
                'border-transparent text-text-muted hover:border-border-glow hover:text-text-base':
                  activeTab !== 'files',
              }"
              class="whitespace-nowrap border-b-2 px-1 py-4 text-sm font-medium transition-colors"
            >
              Ficheiros Importados
            </button>
          </nav>
        </div>

        <div class="mt-6">
          @if (activeTab === 'revenue') {
            <div class="space-y-6">
              <div
                class="rounded-xl border border-border-glass bg-surface-glass p-6 shadow-lg backdrop-blur-md"
              >
                <h3 class="font-semibold text-text-base">Faturamento Diário e Tendência</h3>
                <app-line-chart
                  [xAxisData]="dailyRevenueXAxis"
                  [seriesData]="lineChartSeries"
                ></app-line-chart>
              </div>
              <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                <div
                  class="rounded-xl border border-border-glass bg-surface-glass p-6 shadow-lg backdrop-blur-md"
                >
                  <h3 class="font-semibold text-text-base">Faturamento por Subcategoria</h3>
                  <app-pie-chart
                    uniqueId="revenueSubcategory"
                    [seriesData]="revenueBySubcategoryData"
                  ></app-pie-chart>
                </div>
                <div
                  class="rounded-xl border border-border-glass bg-surface-glass p-6 shadow-lg backdrop-blur-md"
                >
                  <h3 class="font-semibold text-text-base">Faturamento por Forma de Pagamento</h3>
                  <app-pie-chart
                    uniqueId="paymentMethod"
                    [seriesData]="revenueByPaymentMethodData"
                  ></app-pie-chart>
                </div>
              </div>
            </div>
          }

          @if (activeTab === 'expenses') {
            <div class="grid grid-cols-1 gap-6 lg:grid-cols-5">
              <div
                class="rounded-xl border border-border-glass bg-surface-glass p-6 shadow-lg backdrop-blur-md lg:col-span-2"
              >
                <h3 class="font-semibold text-text-base">Despesas por Categoria</h3>
                <app-pie-chart
                  uniqueId="expenses"
                  [seriesData]="expensesBySubcategoryData"
                ></app-pie-chart>
              </div>
              <div
                class="rounded-xl border border-border-glass bg-surface-glass p-6 shadow-lg backdrop-blur-md lg:col-span-3"
              >
                <h3 class="font-semibold text-text-base">Top 10 Maiores Despesas do Mês</h3>
                <div class="mt-4 flow-root">
                  <div class="-mx-6 -my-2 overflow-x-auto">
                    <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                      <table class="min-w-full divide-y divide-border-glass">
                        <thead>
                          <tr>
                            <th
                              scope="col"
                              class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-text-base sm:pl-0"
                            >
                              Descrição
                            </th>
                            <th
                              scope="col"
                              class="px-3 py-3.5 text-left text-sm font-semibold text-text-base"
                            >
                              Valor
                            </th>
                          </tr>
                        </thead>
                        <tbody class="divide-y divide-border-glass">
                          @for (expense of topExpensesData; track expense.description) {
                            <tr>
                              <td class="max-w-xs py-4 pl-4 pr-3 text-sm text-text-muted sm:pl-0">
                                <div class="truncate" title="{{ expense.description }}">
                                  {{ expense.description }}
                                </div>
                              </td>
                              <td
                                class="whitespace-nowrap px-3 py-4 text-sm font-semibold text-red-500"
                              >
                                {{ expense.value | currency: 'BRL' }}
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }

          @if (activeTab === 'files') {
            <div
              class="rounded-xl border border-border-glass bg-surface-glass p-6 shadow-lg backdrop-blur-md"
            >
              <h3 class="font-semibold text-text-base">Ficheiros Processados</h3>
              @if (importedFiles$ | async; as files) {
                @if (files.length > 0) {
                  <div class="mt-4 flow-root">
                    <div class="-mx-6 -my-2 overflow-x-auto">
                      <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                        <table class="min-w-full divide-y divide-border-glass">
                          <thead>
                            <tr>
                              <th
                                scope="col"
                                class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-text-base sm:pl-0"
                              >
                                Nome do Ficheiro
                              </th>
                              <th
                                scope="col"
                                class="px-3 py-3.5 text-left text-sm font-semibold text-text-base"
                              >
                                Transações
                              </th>
                              <th
                                scope="col"
                                class="px-3 py-3.5 text-left text-sm font-semibold text-text-base"
                              >
                                Data de Importação
                              </th>
                              <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0">
                                <span class="sr-only">Ações</span>
                              </th>
                            </tr>
                          </thead>
                          <tbody class="divide-y divide-border-glass">
                            @for (file of files; track file.id) {
                              <tr>
                                <td
                                  class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-text-base sm:pl-0"
                                >
                                  {{ file.fileName }}
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-sm text-text-muted">
                                  {{ file.transactionCount }}
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-sm text-text-muted">
                                  {{ file.importedAt.toDate() | date: 'dd/MM/yyyy HH:mm' }}
                                </td>
                                <td
                                  class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0"
                                >
                                  <button
                                    (click)="deleteImportedFile(file.id!)"
                                    class="text-red-500 hover:text-red-400"
                                  >
                                    Apagar<span class="sr-only">, {{ file.fileName }}</span>
                                  </button>
                                </td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                } @else {
                  <p class="mt-4 text-center text-text-muted">
                    Nenhum ficheiro importado para esta empresa ainda.
                  </p>
                }
              } @else {
                <p class="mt-4 text-center text-text-muted">A carregar ficheiros...</p>
              }
            </div>
          }
        </div>
      </main>
    } @else {
      <div
        class="mt-16 text-center rounded-2xl border border-border-glass bg-surface-glass p-12 shadow-xl backdrop-blur-lg"
      >
        <svg
          class="mx-auto h-12 w-12 text-text-muted"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"
          />
        </svg>
        <h2 class="mt-4 text-xl font-semibold text-text-base">Bem-vindo ao Dallas Finance</h2>
        <p class="mt-2 text-sm text-text-muted">
          Crie sua primeira empresa para começar a importar e analisar seus dados financeiros.
        </p>
        <button
          (click)="openCreateDatasetModal()"
          class="mt-6 inline-flex items-center rounded-lg bg-gradient-to-r from-accent-start to-accent-end px-5 py-2.5 font-semibold text-white shadow-lg transition-transform hover:scale-105"
        >
          Criar Primeira Empresa
        </button>
      </div>
    }
  }

  @if (isUploadModalOpen) {
    <app-modal
      [isOpen]="isUploadModalOpen"
      [title]="'Importar Planilhas'"
      (close)="closeUploadModal()"
    >
      <div class="space-y-4">
        <div>
          @if (datasets$ | async; as datasets) {
            <app-custom-select
              label="Importar para a empresa:"
              [options]="datasets | datasetsToOptions"
              [(ngModel)]="uploadTargetDatasetId"
            ></app-custom-select>
          }
        </div>
        <app-file-uploader (filesSelected)="onFilesEmitted($event)"></app-file-uploader>
      </div>
      <div class="mt-6 flex justify-end border-t border-border-glass pt-5">
        <button
          (click)="processAndUploadFiles()"
          [disabled]="isProcessing"
          class="rounded-lg bg-gradient-to-r from-accent-start to-accent-end px-5 py-2.5 font-semibold text-white shadow-lg transition-transform hover:scale-105 disabled:cursor-not-allowed disabled:opacity-50 disabled:transform-none"
        >
          @if (isProcessing) {
            <span>A Processar...</span>
          } @else {
            <span>Processar Ficheiros</span>
          }
        </button>
      </div>
    </app-modal>
  }
  @if (isCreateDatasetModalOpen) {
    <app-create-dataset-modal
      (create)="handleCreateDataset($event)"
      (close)="closeCreateDatasetModal()"
    ></app-create-dataset-modal>
  }
</div>
